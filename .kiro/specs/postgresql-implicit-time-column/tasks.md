# 实施计划: PostgreSQL隐含时间列功能

## 概述

本实施计划将PostgreSQL隐含时间列功能的设计转化为一系列具体的编码任务。每个任务都建立在前面任务的基础上，最终实现完整的功能集成。所有任务都专注于编写、修改或测试代码。

## 任务

- [x] 1. 设置开发环境和基础结构
  - 配置PostgreSQL源码编译环境
  - 创建功能开发分支
  - 设置测试数据库实例
  - _需求: 所有需求的基础_

- [x] 2. 扩展DDL语法解析器
  - [x] 2.1 修改gram.y文件添加TIME关键字支持
    - 在src/backend/parser/gram.y中添加WITH TIME和WITHOUT TIME语法规则
    - 更新CreateStmt结构体以包含时间列选项
    - _需求: 1.1, 1.2, 1.3_

  - [ ]* 2.2 编写DDL语法解析的属性测试
    - **属性 1: DDL语法解析正确性**
    - **验证需求: Requirements 1.1, 1.2, 1.3, 1.4**

  - [x] 2.3 实现关键字识别和验证逻辑
    - 在src/backend/parser/keywords.c中添加TIME相关关键字
    - 实现语法验证和错误处理逻辑
    - _需求: 1.4, 1.5_

  - [ ]* 2.4 编写语法错误处理的单元测试
    - 测试各种语法错误场景
    - 验证错误信息的清晰度
    - _需求: 1.5_

- [ ] 3. 实现隐含列管理核心功能
  - [ ] 3.1 创建隐含列数据结构和系统表
    - 在src/include/catalog/pg_class.h中添加relhasimplicittime字段
    - 创建pg_implicit_columns系统表定义
    - 实现ImplicitColumn和TableImplicitInfo结构体
    - _需求: 2.1, 2.5_

  - [ ]* 3.2 编写隐含列存储一致性的属性测试
    - **属性 2: 隐含列存储一致性**
    - **验证需求: Requirements 2.1, 2.5**

  - [x] 3.3 实现隐含列管理接口
    - 在src/backend/catalog/中实现add_implicit_time_column()函数
    - 实现table_has_implicit_time()和get_implicit_time_attnum()函数
    - 添加时间戳生成函数get_current_timestamp()
    - _需求: 2.1_

  - [ ]* 3.4 编写隐含列管理的单元测试
    - 测试隐含列的创建和删除
    - 验证系统表的正确更新
    - _需求: 2.1_

- [x] 4. 修改存储层支持隐含列
  - [x] 4.1 扩展元组结构以支持隐含列
    - 修改src/include/access/htup_details.h中的HeapTupleHeaderData
    - 实现隐含列的存储布局逻辑
    - _需求: 2.1, 5.2, 5.3_

  - [x] 4.2 实现隐含列的存储操作
    - 在src/backend/access/heap/heaptuple.c中实现heap_form_tuple_with_implicit()
    - 实现heap_update_implicit_time()和extract_implicit_time()函数
    - _需求: 2.2, 2.3, 5.1_

  - [ ]* 4.3 编写存储管理正确性的属性测试
    - **属性 8: 存储管理正确性**
    - **验证需求: Requirements 5.2, 5.3**

- [x] 5. 实现数据操作的时间戳自动维护
  - [x] 5.1 修改INSERT操作处理
    - 在src/backend/executor/execMain.c中修改ExecInsert()函数
    - 自动为新插入的行设置当前时间戳
    - _需求: 2.2_

  - [x] 5.2 修改UPDATE操作处理
    - 在ExecUpdate()函数中添加时间戳更新逻辑
    - 确保每次更新都刷新时间戳
    - _需求: 2.3, 5.1_

  - [ ]* 5.3 编写时间戳自动维护的属性测试
    - **属性 3: 时间戳自动维护**
    - **验证需求: Requirements 2.2, 2.3, 5.1**

  - [x] 5.4 修改DELETE操作处理
    - 确保DELETE操作正确处理包含隐含列的行
    - 添加必要的清理逻辑
    - _需求: 2.4_

  - [ ]* 5.5 编写删除操作正确性的属性测试
    - **属性 13: 删除操作正确性**
    - **验证需求: Requirements 2.4**

- [ ] 6. 检查点 - 确保核心功能正常工作
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 实现查询处理和可见性控制
  - [ ] 7.1 修改查询规划器处理隐含列
    - 在src/backend/optimizer/plan/planner.c中添加隐含列处理逻辑
    - 实现SELECT *查询的列过滤功能
    - _需求: 3.1, 3.2_

  - [ ] 7.2 实现查询重写逻辑
    - 在src/backend/rewrite/中实现rewrite_query_for_implicit_cols()
    - 实现expand_star_target()和should_include_implicit_column()函数
    - _需求: 3.1, 3.2_

  - [ ]* 7.3 编写查询可见性控制的属性测试
    - **属性 4: 查询可见性控制**
    - **验证需求: Requirements 3.1, 3.2**

  - [ ] 7.4 实现隐含列的WHERE和ORDER BY支持
    - 修改查询执行器以支持隐含列的条件过滤
    - 添加隐含列的排序支持
    - _需求: 3.4, 3.5_

  - [ ]* 7.5 编写隐含列查询功能的属性测试
    - **属性 5: 隐含列查询功能**
    - **验证需求: Requirements 3.4, 3.5**

- [ ] 8. 实现时间格式化和显示
  - [ ] 8.1 实现时间戳格式化函数
    - 在src/backend/utils/adt/timestamp.c中添加格式化逻辑
    - 确保输出格式为'yyyy-mm-dd hh24:mi:ss'
    - _需求: 4.1, 4.2, 4.3_

  - [ ] 8.2 实现服务器时间获取逻辑
    - 确保使用数据库服务器的当前时间
    - 实现秒级精度的时间戳
    - _需求: 4.3, 4.5_

  - [ ]* 8.3 编写时间格式标准化的属性测试
    - **属性 6: 时间格式标准化**
    - **验证需求: Requirements 4.1, 4.2, 4.3, 4.5**

- [ ] 9. 实现事务和并发控制
  - [ ] 9.1 添加事务内时间戳一致性逻辑
    - 在src/backend/access/transam/xact.c中添加事务级时间戳管理
    - 确保同一事务内多次修改的时间戳正确性
    - _需求: 4.4_

  - [ ]* 9.2 编写事务内时间戳一致性的属性测试
    - **属性 7: 事务内时间戳一致性**
    - **验证需求: Requirements 4.4**

  - [ ] 9.3 实现批量操作的时间戳独立性
    - 确保批量UPDATE操作中每行的时间戳独立设置
    - 添加必要的并发控制逻辑
    - _需求: 5.4_

  - [ ]* 9.4 编写批量操作独立性的属性测试
    - **属性 9: 批量操作独立性**
    - **验证需求: Requirements 5.4**

- [ ] 10. 实现系统兼容性功能
  - [ ] 10.1 添加向后兼容性支持
    - 确保现有表的操作保持原有行为
    - 实现兼容性检查逻辑
    - _需求: 3.3, 6.1_

  - [ ]* 10.2 编写向后兼容性的属性测试
    - **属性 10: 向后兼容性**
    - **验证需求: Requirements 3.3, 6.1**

  - [ ] 10.3 实现pg_dump和复制功能支持
    - 修改src/bin/pg_dump/pg_dump.c以支持隐含列
    - 添加复制功能的隐含列同步逻辑
    - _需求: 6.2, 6.3_

  - [ ] 10.4 实现ALTER TABLE操作支持
    - 在src/backend/commands/tablecmds.c中添加隐含列的DDL支持
    - 实现与索引、约束、触发器的兼容性
    - _需求: 6.4, 6.5_

  - [ ]* 10.5 编写系统功能兼容性的属性测试
    - **属性 11: 系统功能兼容性**
    - **验证需求: Requirements 6.2, 6.3, 6.4, 6.5**

- [ ] 11. 实现错误处理和日志记录
  - [ ] 11.1 添加全面的错误处理逻辑
    - 在各个模块中添加错误检查和处理
    - 实现清晰的错误信息生成
    - _需求: 1.5, 7.1, 7.2, 7.4, 7.5_

  - [ ]* 11.2 编写错误处理完整性的属性测试
    - **属性 12: 错误处理完整性**
    - **验证需求: Requirements 1.5, 7.1, 7.2, 7.4, 7.5**

  - [ ] 11.3 实现详细的日志记录功能
    - 在src/backend/utils/error/elog.c中添加隐含列相关日志
    - 确保操作失败时记录足够的诊断信息
    - _需求: 7.3_

  - [ ]* 11.4 编写日志记录完整性的属性测试
    - **属性 14: 日志记录完整性**
    - **验证需求: Requirements 7.3**

- [ ] 12. 集成测试和性能优化
  - [ ] 12.1 编写综合集成测试
    - 创建端到端的功能测试用例
    - 验证所有功能的协同工作
    - _需求: 所有需求_

  - [ ] 12.2 进行性能基准测试
    - 对比启用和未启用隐含列的性能差异
    - 优化关键路径的性能
    - _需求: 5.5_

  - [ ]* 12.3 编写性能回归测试
    - 确保功能不会显著影响现有性能
    - 建立性能基准线
    - _需求: 5.5_

- [ ] 13. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为`*`的任务是可选的，可以跳过以实现更快的MVP
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况