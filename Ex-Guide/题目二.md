# å®éªŒäºŒï¼šPostgreSQL æ•°æ®åº“ç‰©ç†å­˜å‚¨ç»“æ„åˆ†æ

## ä¸€ã€å®éªŒç¯å¢ƒå‡†å¤‡

### 1.1 ç¯å¢ƒè¦æ±‚

- PostgreSQL â‰¥ 12ï¼ˆUXDB åŒç†ï¼‰
- Linuxï¼ˆCentOS / Ubuntu å‡å¯ï¼‰
- æœ‰æ•°æ®åº“ superuser æƒé™

```bash
psql --version
```

### 1.2 è¿æ¥æ•°æ®åº“

```bash
sudo -i -u uxdb
psql -U uxdb
```

## äºŒã€æŸ¥çœ‹æ™®é€šè¡¨åœ¨ç£ç›˜ä¸­çš„ç»„ç»‡ç»“æ„ï¼ˆHeap Tableï¼‰

### 2.1 åˆ›å»ºå®éªŒè¡¨å¹¶æ’å…¥æ•°æ®

```sql
DROP TABLE IF EXISTS t_heap;

CREATE TABLE t_heap (
    id INT,
    name TEXT
);

INSERT INTO t_heap
SELECT i, 'name_' || i
FROM generate_series(1, 1000) i;
```

### 2.2 å®šä½è¡¨çš„ç‰©ç†æ–‡ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰

#### â‘  æŸ¥è¯¢ relfilenode

```sql
SELECT relname, relfilenode
FROM pg_class
WHERE relname = 't_heap';
```

å‡è®¾è¿”å›ï¼š
```
relfilenode = 16508
```

#### â‘¡ æŸ¥è¯¢æ•°æ®åº“ OID

```sql
SELECT oid FROM pg_database WHERE datname = current_database();
```

å‡è®¾ï¼š
```
oid = 16387
```

#### â‘¢ å®šä½ç£ç›˜æ–‡ä»¶

é€€å‡ºæ•°æ®åº“ï¼š
```sql
\q
```

å®šä½æ–‡ä»¶ï¼š
```bash
cd /home/uxdb/uxdb/base/16387
ls -lh 16508*
```

ä½ ä¼šçœ‹åˆ°ï¼š
```
16508        -- ä¸»æ•°æ®æ–‡ä»¶
16508_fsm    -- ç©ºé—²ç©ºé—´æ˜ å°„
16508_vm     -- å¯è§æ€§æ˜ å°„
```

ğŸ“Œ **è¯´æ˜**ï¼š
- **Heap è¡¨ä»¥ 8KB Page ä¸ºå•ä½å­˜å‚¨**
- è¡Œæ•°æ®ä»¥ tuple å½¢å¼å­˜å‚¨åœ¨ Page ä¸­

### 2.3 æŸ¥çœ‹å †è¡¨é¡µé¢å†…éƒ¨ç»“æ„ï¼ˆé¡µçº§ï¼‰

#### â‘  å®‰è£… pageinspect æ‰©å±•

é‡æ–°è¿æ¥æ•°æ®åº“ï¼š
```bash
sudo -i -u uxdb
psql -U uxdb
```

```sql
CREATE EXTENSION pageinspect;
```

#### â‘¡ æŸ¥çœ‹ç¬¬ 0 é¡µåŸå§‹å†…å®¹

```sql
SELECT * FROM heap_page_items(get_raw_page('t_heap', 0));
```

ä½ å°†çœ‹åˆ°ï¼š
- tuple åç§»é‡
- xmin / xmax
- tuple å¤§å°
- æ˜¯å¦å¯è§

ğŸ“Œ è¿™ä¸€å±‚å¯¹åº” **Heap Page ç‰©ç†å¸ƒå±€**ï¼š
```
PageHeader
ItemId æ•°ç»„
HeapTuple æ•°æ®
```

## ä¸‰ã€æŸ¥çœ‹ B-Tree ç´¢å¼•åœ¨ç£ç›˜ä¸­çš„ç»„ç»‡ç»“æ„

### 3.1 åˆ›å»º B-Tree ç´¢å¼•

```sql
CREATE INDEX idx_t_heap_id ON t_heap(id);
```

### 3.2 å®šä½ç´¢å¼•ç‰©ç†æ–‡ä»¶

```sql
SELECT relname, relfilenode
FROM pg_class
WHERE relname = 'idx_t_heap_id';
```

é€€å‡ºæ•°æ®åº“ï¼š
```sql
\q
```

å®šä½æ–¹å¼ä¸è¡¨å®Œå…¨ä¸€è‡´ï¼š
```bash
/home/uxdb/uxdb/base/<db_oid>/<relfilenode>
```

ğŸ“Œ ç´¢å¼•åªæœ‰ï¼š
```
<relfilenode>      -- ç´¢å¼•é¡µ
<relfilenode>_fsm
```

> âš ï¸ ä¸‹é¢åœ¨ **Linux shell** æ‰§è¡Œ

```bash
cd /home/uxdb/uxdb/base/16387
ls -lh 16508*
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```
16507
16507_fsm
```

**è¯´æ˜**ï¼š
- ç´¢å¼•æ²¡æœ‰ `_vm`ï¼ˆåªæœ‰ heap æ‰æœ‰ï¼‰
- ç´¢å¼•é¡µåŒæ ·æ˜¯ **8KB Page**

### 3.3 æŸ¥çœ‹ B-Tree ç´¢å¼•å…ƒæ•°æ®é¡µ

é‡æ–°è¿æ¥æ•°æ®åº“ï¼š
```bash
sudo -i -u uxdb
psql -U uxdb
```

```sql
SELECT * FROM bt_metap('idx_t_heap_id');
```

ä½ ä¼šçœ‹åˆ°ï¼š
- root block
- tree level
- fast root
- version

ğŸ“Œ **B-Tree çš„ç¬¬ 0 é¡µæ˜¯ Meta Page**

### 3.4 æŸ¥çœ‹ç´¢å¼•é¡µç»“æ„ï¼ˆæ ¸å¿ƒï¼‰

#### æŸ¥çœ‹ Root é¡µ

```sql
SELECT * FROM bt_page_items('idx_t_heap_id', 1);
```

**å­—æ®µè¯´æ˜**ï¼š
- `itemoffset`ï¼šé¡µå†…åç§»
- `ctid`ï¼šæŒ‡å‘ heap tuple
- `data`ï¼šç´¢å¼• key
- `dead`ï¼šæ˜¯å¦å·²å¤±æ•ˆ

#### æŸ¥çœ‹å¶å­é¡µ

```sql
SELECT * FROM bt_page_items('idx_t_heap_id', 2);
```

ğŸ“Œ **ä½ å°†æ¸…æ¥šçœ‹åˆ°**ï¼š
```
Internal Page â†’ Leaf Page â†’ Heap TID
```

## å››ã€æŸ¥çœ‹ checkpoint ç‚¹ä¸ redo ç‚¹ï¼ˆWAL æœºåˆ¶ï¼‰

### 4.1 æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡ checkpointï¼ˆSQLï¼‰

```sql
SELECT * FROM pg_control_checkpoint();
```

**é‡ç‚¹å­—æ®µ**ï¼š

| å­—æ®µ           | å«ä¹‰            |
|----------------|-----------------|
| checkpoint_lsn | checkpoint ä½ç½® |
| redo_lsn       | redo èµ·å§‹ç‚¹     |
| next_xid       | ä¸‹ä¸€ä¸ªäº‹åŠ¡å·    |

ğŸ“Œ **æ•°æ®åº“å´©æºƒæ¢å¤ä» redo_lsn å¼€å§‹**

### 4.2 æŸ¥çœ‹å½“å‰ WAL å†™å…¥ç‚¹

```sql
SELECT pg_current_wal_lsn();
```

### 4.3 æŸ¥çœ‹ checkpoint ç»Ÿè®¡ä¿¡æ¯

```sql
SELECT * FROM pg_stat_bgwriter;
```

ä½ å¯ä»¥è§‚å¯Ÿï¼š
- checkpoint æ¬¡æ•°
- buffer å†™å›æƒ…å†µ

### 4.4 æ–‡ä»¶çº§æŸ¥çœ‹ï¼ˆæœ€æƒå¨ï¼‰

é€€å‡ºæ•°æ®åº“ï¼š
```sql
\q
```

æŸ¥çœ‹æ§åˆ¶æ•°æ®ï¼š
```bash
pg_controldata /home/uxdb/uxdb
```

å…³é”®è¾“å‡ºï¼š
```
Latest checkpoint location
Latest checkpoint's REDO location
```

ğŸ“Œ è¿™ä¸¤ä¸ªå€¼ **= pg_control_checkpoint çš„åº•å±‚æ¥æº**

### 4.5 WAL æ–‡ä»¶ç›®å½•è§‚å¯Ÿ

```bash
ls /home/uxdb/uxdb/pg_wal/
```

**è¯´æ˜**ï¼š
- WAL æ–‡ä»¶åæŒ‰ LSN é¡ºåºé€’å¢
- redo_lsn ä¹‹å‰ WAL å¯å›æ”¶
- redo_lsn ä¹‹å WAL å¿…é¡»å­˜åœ¨
