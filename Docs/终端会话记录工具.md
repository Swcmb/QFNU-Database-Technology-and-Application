# 终端会话记录工具使用指南

## 一、script 命令

### 1.1 基本使用

如果你想记录从现在开始到退出为止，你在终端里输入的所有指令及其产生的所有输出，`script` 是最好的选择。

**启动记录**：

```bash
script my_session.txt
```

执行后，系统会提示 `Script started, file is my_session.txt`。此时你进行的所有操作都会被记录。

**执行你的操作**：

正常输入各种命令，如 yum update、df -h 等。

**停止记录**：

输入 `exit` 或按 `Ctrl + D`。

系统会提示 `Script done, file is my_session.txt`。此时你可以用 `cat my_session.txt` 查看完整的"回放"。

### 1.2 处理截断问题

如果 `script` 命令记录的文件被截断，可能有以下几个原因和解决方案：

#### 检查文件系统空间

```bash
# 查看磁盘剩余空间
df -h .

# 查看当前目录可用空间
du -sh my_session.txt
```

#### 指定更大的缓冲区大小（某些系统）

```bash
# 有些版本的 script 有 -c 选项可以指定缓存大小
script -c 4096 my_session.txt
# 或
script -B 8192 my_session.txt
```

#### 使用 -f 选项实时刷新（避免缓存问题）

```bash
# Linux 系统通常支持 -f 或 --flush
script -f my_session.txt
# 或
script --flush my_session.txt
```

#### 强制终止记录并查看部分内容

如果会话意外终止导致截断，可以尝试：

```bash
# 查看文件末尾
tail -n 100 my_session.txt

# 查看文件大小
ls -lh my_session.txt

# 查看是否真的被截断
wc -l my_session.txt
```

#### 使用替代方案：script 结合 tee

```bash
# 双重记录，避免丢失
script | tee my_session.txt
# 或
script my_session.txt 2>&1 | tee -a my_session_tee.txt
```

### 1.3 高级用法

#### 完整记录命令示例

```bash
script --timing=time.log --flush --command=/bin/bash my_session.txt
```

参数说明：
- `--timing=time.log`：记录时间信息
- `--flush`：实时写入
- `--command=/bin/bash`：明确指定shell

#### 预防措施

```bash
# 1. 在记录前检查 inode
df -i .

# 2. 设置 ulimit 避免文件大小限制
ulimit -f unlimited

# 3. 使用脚本包装，自动分割大文件
cat > record_session.sh << 'EOF'
#!/bin/bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="session_${TIMESTAMP}.log"
MAX_SIZE=104857600  # 100MB

# 记录会话，每100MB分割
script -f ${LOG_FILE} --command "watch -n 1 'du -b ${LOG_FILE}'"

# 或者使用 split 命令分割
# script -f ${LOG_FILE} && split -b 100M ${LOG_FILE} "session_part_"
EOF
chmod +x record_session.sh
```

### 1.4 恢复截断的文件

```bash
# 使用 strings 命令提取可读内容
strings my_session.txt > recovered.txt

# 使用 hexdump 查看文件结尾是否完整
tail -c 100 my_session.txt | hexdump -C
```

---

## 二、screen 工具

### 2.1 安装

```bash
sudo yum install -y screen
```

### 2.2 使用 screen 记录会话

```bash
# 使用 screen 记录
screen -L -Logfile my_session.log

# 在 screen 中操作
# 退出时按 Ctrl+A, D
```

结束后查看 `my_session.log`。

---

## 三、asciinema 工具

### 3.1 安装

```bash
sudo yum install -y asciinema
```

### 3.2 记录会话

```bash
# 记录
asciinema rec session.cast
```

### 3.3 回放和转换

```bash
# 退出后可以回放
asciinema play session.cast

# 转为文本
asciinema cat session.cast > session.txt
```

---

## 四、ttyrec 工具

### 4.1 安装

```bash
sudo yum install -y ttyrec
```

### 4.2 记录和回放

```bash
# 记录
ttyrec session.tty

# 回放
ttyplay session.tty
```

---

## 五、最佳实践建议

如果经常遇到截断问题，建议优先使用以下工具：

1. **screen -L** - 对长时间会话的记录更稳定
2. **asciinema** - 功能更强大，支持回放和转换

### 推荐工作流程

```bash
# 方法1: 使用 screen（推荐用于长时间会话）
screen -L -Logfile my_session.log
# 操作完成后
exit

# 方法2: 使用 asciinema（推荐用于演示和分享）
asciinema rec session.cast
# 操作完成后
exit
asciinema play session.cast

# 方法3: 使用 script（简单直接）
script -f --timing=time.log my_session.txt
# 操作完成后
exit
```